<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>hbd</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            display: flex;
            flex-direction: column; /* Changed to column to stack elements */
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #D1D5DB;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Prevent scrollbars */
        }
        /* Custom styling for progress bar for better appearance */
        progress {
            /* Reset default styles */
            -webkit-appearance: none;
            appearance: none;
            width: 80%; /* Make it take up a good portion of the width */
            max-width: 600px; /* Max width for larger screens */
            height: 20px; /* Slightly taller for better visibility */
            border-radius: 9999px; /* Full rounded corners */
            overflow: hidden; /* Hide overflow for rounded fill */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            cursor: pointer;
        }

        /* Style for the track (background) */
        progress::-webkit-progress-bar {
            background-color: #e2e8f0; /* Tailwind gray-200 */
            border-radius: 9999px;
        }

        progress::-moz-progress-bar {
            background-color: #e2e8f0; /* Tailwind gray-200 */
            border-radius: 9999px;
        }

        /* Style for the filled portion */
        progress::-webkit-progress-value {
            background-color: #6ee7b7; /* Tailwind emerald-400 - a light shade of green */
            border-radius: 9999px;
            transition: width 0.1s linear; /* Smooth transition for progress */
        }

        progress::-moz-progress-bar {
            background-color: #6ee7b7; /* Tailwind emerald-400 - a light shade of green */
            border-radius: 9999px;
            transition: width 0.1s linear;
        }

        /* Equalizer Canvas styling */
        #equalizerCanvas {
            width: 100px; /* Fixed width for the canvas */
            height: 50px; /* Fixed height for the canvas */
            margin-bottom: 1rem; /* Space between canvas and progress bar */
            opacity: 1; /* Always visible */
        }

        #wishBtn {
            visibility: hidden;
            cursor: pointer;
            padding-top: 12px;
        }

        .zoom-in-out-element {
            animation: zoom-in-zoom-out 1s ease infinite;
        }
        @keyframes zoom-in-zoom-out {
            0% {
                scale: 100%;
            }
            50% {
                scale: 80%;
            }
            100% {
                scale: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <!-- Audio Element (hidden, controlled by JavaScript) -->
    <audio id="audioPlayer" class="hidden">
        <!-- Replace with your actual audio clip URL -->
        <!-- <source src="short.mov" type="audio/mpeg"> -->
        <source src="clipped_full.wav" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <div id="playText" class="text-sm italic text-gray-400">Click on screen to play</div>

    <!-- Equalizer Canvas -->
    <canvas id="equalizerCanvas" width="100" height="50"></canvas>

    <!-- Progress Bar -->
    <progress id="progressBar" value="0" max="100"></progress>

    <div id="wishBtn">
        <img class="zoom-in-out-element" src="wish_btn.gif" width="100" style="justify-self: center;">
        <div class="text-sm italic text-gray-400" style="justify-self: center;">See wishes</div>
    </div>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const progressBar = document.getElementById('progressBar');
        const equalizerCanvas = document.getElementById('equalizerCanvas');
        const playText = document.getElementById('playText');
        const wishBtn = document.getElementById('wishBtn');
        const ctx = equalizerCanvas.getContext('2d');

        // Equalizer animation variables
        let animationFrameId = null;
        const canvasW = 100;
        const barCount = 4;
        const barWidth = 8;
        const barSpacing = 8;
        const barColor = '#6ee7b7';

        // Store static heights for paused state
        let staticBarHeights = Array(barCount).fill(0);

        /**
         * Generates random heights for the static equalizer bars.
         */
        function generateStaticBarHeights() {
            for (let i = 0; i < barCount; i++) {
                // Generate a random height within a smaller range (e.g., 30% to 70% of canvas height)
                staticBarHeights[i] = (Math.random() * (equalizerCanvas.height * 0.4) + (equalizerCanvas.height * 0.3));
            }
        }

        /**
         * Draws the equalizer bars on the canvas.
         * The animation varies based on whether the audio is playing or paused.
         */
        function drawEqualizer() {
            ctx.clearRect(0, 0, equalizerCanvas.width, equalizerCanvas.height); // Clear canvas
            const xoffset = (canvasW - barCount * barWidth  - (barCount - 1) * barSpacing) / 2;

            if (!audioPlayer.paused) {
                // When playing, draw dynamic bars
                for (let i = 0; i < barCount; i++) {
                    const x = i * (barWidth + barSpacing);
                    // Random height for animation, scaled by current volume
                    const height = (Math.random() * (equalizerCanvas.height * 0.8) + (equalizerCanvas.height * 0.2)) * audioPlayer.volume;
                    const y = equalizerCanvas.height - height; // Draw from bottom up

                    ctx.fillStyle = barColor;
                    ctx.fillRect(x + xoffset, y, barWidth, height);
                }
                // Continue animation loop only if playing
                animationFrameId = requestAnimationFrame(drawEqualizer);
            } else {
                // When paused, draw static bars based on pre-generated heights
                for (let i = 0; i < barCount; i++) {
                    const x = i * (barWidth + barSpacing);
                    const height = staticBarHeights[i]; // Use the pre-generated static height
                    const y = equalizerCanvas.height - height; // Draw from bottom up

                    ctx.fillStyle = barColor;
                    ctx.fillRect(x + xoffset, y, barWidth, height);
                }
                // Do NOT continue animation loop if paused
                if (animationFrameId) {
                    cancelAnimationFrame(animationFrameId);
                    animationFrameId = null;
                }
            }
        }

        function showWishBtn() {
            wishBtn.style.visibility = 'visible';
        }

        /**
         * Starts the audio playback instantly.
         */
        function startPlayback() {
            audioPlayer.volume = 1; // Set volume to full instantly
            audioPlayer.play().catch(error => {
                console.error("Play prevented:", error);
            });

            // Start the animation loop when playing begins
            if (!animationFrameId) {
                drawEqualizer();
            }

            playText.style.visibility = 'hidden';
        }

        /**
         * Pauses the audio playback instantly.
         */
        function pausePlayback(isEnd) {
            audioPlayer.volume = 0; // Set volume to zero instantly
            audioPlayer.pause(); // Pause the audio

            // Stop the animation loop and generate new static heights for the paused state
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            generateStaticBarHeights(); // Generate new static heights for the pause
            drawEqualizer(); // Draw one frame with the new static heights
            playText.style.visibility = 'visible';
        }

        function isPageClick(target) {
            return target !== progressBar && target !== wishBtn;
        }


        // Event listener when audio metadata is loaded
        audioPlayer.addEventListener('loadedmetadata', () => {
            progressBar.max = audioPlayer.duration;
            // Generate initial static heights and draw them once
            generateStaticBarHeights();
            drawEqualizer();
        });

        // Event listener for time updates during playback
        audioPlayer.addEventListener('timeupdate', () => {
            progressBar.value = audioPlayer.currentTime;

            // Trigger pause and reset if approaching the end of the clip
            if (audioPlayer.currentTime >= audioPlayer.duration - 0.1 && !audioPlayer.paused) { // Check near end
                audioPlayer.currentTime = 0; // Reset to beginning
                progressBar.value = 0; // Reset progress bar
                pausePlayback(); // Pause and show static equalizer
            }

            if (audioPlayer.currentTime >= audioPlayer.duration - 5) {
                showWishBtn();
            }
        });

        // Event listener when audio ends (fallback)
        audioPlayer.addEventListener('ended', () => {
            audioPlayer.currentTime = 0;
            progressBar.value = 0;
            pausePlayback(); // Pause and show static equalizer
            showWishBtn();
        });


        // Tap anywhere on the body to pause/resume the audio
        document.body.addEventListener('click', () => {
            if (!isPageClick(event.target)) {
                return; // Do nothing, the progress bar has its own listener
            }

            if (audioPlayer.paused) {
                // If paused, ensure it starts from beginning if it's the very start or after an 'ended' event
                if (audioPlayer.currentTime === 0 || audioPlayer.ended) {
                    audioPlayer.currentTime = 0;
                    progressBar.value = 0;
                }
                startPlayback();
            } else {
                pausePlayback();
            }
        });

        // Add the new event listener for seeking functionality
        progressBar.addEventListener('click', (event) => {
            if (audioPlayer.paused) {
                startPlayback();
                return;
            }
            // Get the click position relative to the progress bar
            const clickPosition = event.offsetX;
            // Get the total width of the progress bar
            const progressBarWidth = progressBar.offsetWidth;
            // Calculate the percentage of the click
            const clickPercentage = clickPosition / progressBarWidth;
            // Calculate the new time for the audio clip
            const newTime = audioPlayer.duration * clickPercentage;
            // Set the audio's current time to the new time
            audioPlayer.currentTime = newTime;
        });

        wishBtn.addEventListener('click', () => {
            if (!isPageClick(event.target)) {
                return;
            }

            let key = prompt("Enter key");
            if (!isValidKey(key)) {
                key = prompt("Incorrect key! try again")
            }
            if (!isValidKey(key)) { 
                window.location.href = "https://www.google.com/search?q=happy+birthday+stranger";
            } else {
                window.location.href = "/wish/index.html?k=" + key;
            }
        });

    </script>
    <script type="module" src="main.js"></script>
    <script src="aes.js"></script>
    <script src="data.js"></script>
    <script src="data_parser.js"></script>
</body>
</html>
